# {{ site_name }} - Static Site Configuration
# Generated by {{ generator }} at {{ generated_time }}
# Performance Baseline: Applied (F5/CIS Best Practices)
# HTTPS Security: {% if enable_https %}Enabled{% else %}Disabled{% endif %}

server {
    listen {{ listen_port }}{% if enable_https and https_security.http2_enabled %} http2{% endif %};
    server_name {{ server_name }};
    
    # ============================================
    # 性能优化基线 (Performance Baseline)
    # 来源: F5 Tuning Guide, CIS Benchmarks 2025-2026
    # ============================================
    
    # 连接优化
    keepalive_timeout {{ performance_baseline.keepalive_timeout }};
    keepalive_requests {{ performance_baseline.keepalive_requests }};
    
    # Gzip压缩配置
    {% if performance_baseline.gzip_enabled %}
    gzip on;
    gzip_comp_level {{ performance_baseline.gzip_comp_level }};
    gzip_min_length {{ performance_baseline.gzip_min_length }};
    gzip_vary {{ performance_baseline.gzip_vary | nginx_bool }};
    gzip_proxied {{ performance_baseline.gzip_proxied }};
    gzip_types {{ performance_baseline.gzip_types | join(' ') }};
    {% endif %}
    
    # 高效传输
    sendfile {{ performance_baseline.sendfile_enabled | nginx_bool }};
    tcp_nopush {{ performance_baseline.tcp_nopush | nginx_bool }};
    tcp_nodelay {{ performance_baseline.tcp_nodelay | nginx_bool }};
    
    # 请求限制
    client_max_body_size {{ performance_baseline.client_max_body_size }};
    client_body_timeout {{ performance_baseline.client_body_timeout }};
    client_header_timeout {{ performance_baseline.client_header_timeout }};
    send_timeout {{ performance_baseline.send_timeout }};
    
    # 日志优化
    {% if performance_baseline.access_log == "off" %}
    access_log off;
    {% else %}
    access_log logs/{{ site_name }}_access.log combined buffer=32k flush=5m;
    {% endif %}
    
    error_log logs/{{ site_name }}_error.log {{ performance_baseline.error_log_level }};
    
    # ============================================
    # 安全加固 (Security Hardening)
    # ============================================
    
    # 隐藏版本信息
    server_tokens {{ common_security.server_tokens }};
    
    # 隐藏.开头文件
    {% if common_security.hide_dot_files %}
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    {% endif %}
    
    # 请求限制（防DDoS/爆破）
    limit_req_zone $binary_remote_addr zone={{ site_name }}_req:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone={{ site_name }}_conn:10m;
    limit_req zone={{ site_name }}_req burst=20 nodelay;
    limit_conn {{ site_name }}_conn 20;
    
    # 缓冲区限制（防缓冲区溢出）
    client_body_buffer_size {{ common_security.client_body_buffer_size }};
    client_header_buffer_size {{ common_security.client_header_buffer_size }};
    large_client_header_buffers {{ common_security.large_client_client_header_buffers }};
    
    # ============================================
    # 站点配置
    # ============================================
    
    # 根目录和索引
    root "{{ root_path }}";
    index {{ index_file }};
    
    # 主location
    location / {
        try_files $uri $uri/ =404;
        
        # 安全头（基础）
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
    
    # ============================================
    # HTTPS配置（可选）
    # ============================================
    {% if enable_https %}
    
    # 监听443端口
    listen 443 ssl{% if https_security.http2_enabled %} http2{% endif %};
    
    # SSL证书配置
    ssl_certificate "{{ ssl_cert_path }}";
    ssl_certificate_key "{{ ssl_key_path }}";
    
    # TLS协议版本（仅允许1.2和1.3）
    ssl_protocols {{ https_security.ssl_protocols | join(' ') }};
    
    # 强加密套件
    ssl_ciphers {{ https_security.ssl_ciphers }};
    ssl_prefer_server_ciphers {{ https_security.ssl_prefer_server_ciphers }};
    
    # SSL会话缓存
    ssl_session_cache {{ https_security.ssl_session_cache }};
    ssl_session_timeout {{ https_security.ssl_session_timeout }};
    ssl_session_tickets {{ https_security.ssl_session_tickets }};
    
    # OCSP Stapling
    ssl_stapling {{ https_security.ssl_stapling }};
    ssl_stapling_verify {{ https_security.ssl_stapling_verify }};
    
    # HSTS（强制HTTP转HTTPS）
    {% if https_security.hsts_enabled %}
    add_header Strict-Transport-Security "max-age={{ https_security.hsts_max_age }}{% if https_security.hsts_include_subdomains %} ; includeSubDomains{% endif %}{% if https_security.hsts_preload %} ; preload{% endif %}" always;
    {% endif %}
    
    # HTTPS专用安全头（严格模式）
    location / {
        try_files $uri $uri/ =404;
        
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        {% if https_security.https_security_headers.Content-Security-Policy %}
        add_header Content-Security-Policy "{{ https_security.https_security_headers.Content-Security-Policy }}" always;
        {% endif %}
    }
    {% endif %}
}
