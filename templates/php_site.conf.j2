# {{ site_name }} - PHP Site Configuration
# Generated by {{ generator }} at {{ generated_time }}
# Performance Baseline: Applied (F5/CIS Best Practices)
# HTTPS Security: {% if enable_https %}Enabled{% else %}Disabled{% endif %}

server {
    {% if not enable_https %}
    listen {{ listen_port }};
    {% endif %}
    server_name {{ server_name }};
    
    # ============================================
    # 性能优化基线 (Performance Baseline)
    # 来源: F5 Tuning Guide, CIS Benchmarks 2025-2026
    # ============================================
    
    # 连接优化
    keepalive_timeout {{ performance_baseline.keepalive_timeout }};
    keepalive_requests {{ performance_baseline.keepalive_requests }};
    
    # Gzip压缩配置
    {% if performance_baseline.gzip_enabled %}
    gzip on;
    gzip_comp_level {{ performance_baseline.gzip_comp_level }};
    gzip_min_length {{ performance_baseline.gzip_min_length }};
    gzip_vary {{ performance_baseline.gzip_vary | nginx_bool }};
    gzip_proxied {{ performance_baseline.gzip_proxied }};
    gzip_types {{ performance_baseline.gzip_types | join(' ') }};
    {% endif %}
    
    # 高效传输
    sendfile {{ performance_baseline.sendfile_enabled | nginx_bool }};
    tcp_nopush {{ performance_baseline.tcp_nopush | nginx_bool }};
    tcp_nodelay {{ performance_baseline.tcp_nodelay | nginx_bool }};
    
    # 请求限制
    client_max_body_size {{ performance_baseline.client_max_body_size }};
    client_body_timeout {{ performance_baseline.client_body_timeout }};
    client_header_timeout {{ performance_baseline.client_header_timeout }};
    send_timeout {{ performance_baseline.send_timeout }};
    
    # 日志优化
    {% if performance_baseline.access_log == "off" %}
    access_log off;
    {% else %}
    access_log logs/{{ site_name }}_access.log combined buffer=32k flush=5m;
    {% endif %}
    
    error_log logs/{{ site_name }}_error.log {{ performance_baseline.error_log_level }};
    
    # ============================================
    # 安全加固 (Security Hardening)
    # ============================================
    
    # 隐藏版本信息
    server_tokens {{ common_security.server_tokens }};
    
    # 隐藏.开头文件
    {% if common_security.hide_dot_files %}
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    {% endif %}
    
    # 请求限制（防DDoS/爆破）
    limit_req zone=api burst=20 nodelay;
    limit_conn addr 20;
    
    # 缓冲区限制（防缓冲区溢出）
    client_body_buffer_size {{ common_security.client_body_buffer_size }};
    client_header_buffer_size {{ common_security.client_header_buffer_size }};
    large_client_header_buffers {{ common_security.large_client_header_buffers }};
    
    # ============================================
    # 站点配置
    # ============================================
    
    # 根目录和索引
    root "{{ root_path }}";
    index index.php index.html index.htm;
    
    # PHP-FPM配置
    {% if php_fpm_mode == "unix" %}
    set $php_fpm "{{ php_fpm_socket }}";
    {% else %}
    set $php_fpm "{{ php_fpm_host }}:{{ php_fpm_port }}";
    {% endif %}
    
    # 主location
    location / {
        try_files $uri $uri/ /index.php?$query_string;
        
        # 安全头（基础）
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
    
    # WordPress特定规则（如果检测到）
    location /wp-content/ {
        try_files $uri $uri/ =404;
    }
    
    # PHP文件处理
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass $php_fpm;
        fastcgi_index index.php;
        
        # PHP参数
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_URI $document_uri;
        fastcgi_param DOCUMENT_ROOT $document_root;
        fastcgi_param SERVER_PROTOCOL $server_protocol;
        fastcgi_param REQUEST_SCHEME $scheme;
        fastcgi_param HTTPS $https if_not_empty;
        fastcgi_param REMOTE_ADDR $remote_addr;
        fastcgi_param REMOTE_PORT $remote_port;
        fastcgi_param SERVER_ADDR $server_addr;
        fastcgi_param SERVER_PORT $server_port;
        fastcgi_param SERVER_NAME $server_name;
        
        # PHP优化参数
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        
        # 超时设置
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;
        
        include fastcgi_params;
    }
    
    # 隐藏PHP文件
    location ~ /\.php$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ============================================
    # HTTPS配置（可选）
    # ============================================
    {% if enable_https %}
    
    # 监听端口（SSL）
    listen {{ listen_port }} ssl;
    
    # HTTP/2 支持（Nginx 1.25.1+）
    {% if https_security.http2_enabled %}
    http2 on;
    {% endif %}
    
    # SSL证书配置
    ssl_certificate "{{ ssl_cert_path }}";
    ssl_certificate_key "{{ ssl_key_path }}";
    
    # TLS协议版本（仅允许1.2和1.3）
    ssl_protocols {{ https_security.ssl_protocols | join(' ') }};
    
    # 强加密套件
    ssl_ciphers {{ https_security.ssl_ciphers }};
    ssl_prefer_server_ciphers {{ https_security.ssl_prefer_server_ciphers }};
    
    # SSL会话缓存
    ssl_session_cache {{ https_security.ssl_session_cache }};
    ssl_session_timeout {{ https_security.ssl_session_timeout }};
    ssl_session_tickets {{ https_security.ssl_session_tickets }};
    
    # OCSP Stapling
    ssl_stapling {{ https_security.ssl_stapling }};
    ssl_stapling_verify {{ https_security.ssl_stapling_verify }};
    
    # HSTS（强制HTTP转HTTPS）
    {% if https_security.hsts_enabled %}
    add_header Strict-Transport-Security "max-age={{ https_security.hsts_max_age }}{% if https_security.hsts_include_subdomains %} ; includeSubDomains{% endif %}{% if https_security.hsts_preload %} ; preload{% endif %}" always;
    {% endif %}
    {% endif %}
}
